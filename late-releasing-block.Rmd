---
output:
  html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: 0;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>
<style>
.blackbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid #7f7f7f;
  width: 100%;
  position: center;
  align: center;
  margin: 0px auto;
}
.center {
  text-align: left;
  margin: 0px auto;
}
</style>
<!-- ```{css toc-content, echo = FALSE} -->
<!-- #TOC { -->
<!--   right: 270px; -->
<!--   margin: 20px 0px 25px 0px; -->
<!-- } -->
<!-- .main-container { -->
<!--     margin-left: 200px; -->
<!-- } -->
<!-- ``` -->
```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
  library(lubridate)
})

# devtools::install_github("hafen/lazyrmd")
# require(lazyrmd)
# 
# options(repos = c(tessera = "http://packages.tessera.io",
#   getOption("repos")))
# install.packages("lazyrmd")
# require(lazyrmd)

```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Data Connections, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn3 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Production", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")
conn4 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Staging", timeout = 30)

conn5 <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    # Server = "10.2.42.69", # old server
                    Server = "datahub-synapse.sql.azuresynapse.net",
                    database = "datahub_epic_dw",
                    UID = "MSS_USER",
                    PWD = "Apple_Bees456$",
                    Port = 1433)



# Clarity Connection  ------------------------------------------------
slot_raw_tbl <- tbl(conn2, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")
f_sched_appt_tbl <- tbl(conn2, "F_SCHED_APPT")
availability_raw_tbl <- tbl(conn2, "V_AVAILABILITY")
block_raw_tbl <- tbl(conn2, "AVAIL_BLOCK")
block_name_tbl <- tbl(conn2, "ZC_APPT_BLOCK")
orders_raw_tbl <- tbl(conn2, "ORDER_PROC")
visit_type_tbl <- tbl(conn2, "CL_PRC_VT_GROUPS")
visit_type_mapping_tbl <- tbl(conn2, "ZC_VISIT_TYPE_GRP")

dep_mapping_tbl <- tbl(conn2, "CLARITY_DEP")
dep_mapping <- dep_mapping_tbl %>%
  # dplyr::select(DEPARTMENT_ID, SPECIALTY) %>%
  collect()

clarity_ser_tbl <- tbl(conn2, "CLARITY_SER")
clarity_ser_2_tbl <- tbl(conn2, "CLARITY_SER_2")

finclass_tbl <- tbl(conn2, "V_PB_EPP_CUSTOM_PRD_TYPE")


# Local Connection ---------------------------------------------------
radiology_dep_mapping_tbl <- tbl(conn1, "RADIOLOGY_DEP_MAPPING")

clarity_ser_tbl_loc <- tbl(conn1, "CLARITY_SER")
clarity_ser_2_tbl_loc <- tbl(conn1, "CLARITY_SER_2")

dep_mapping_tbl_loc <- tbl(conn1, "CLARITY_DEP")

slot_data_raw_tbl <- tbl(conn1, "ALL_SLOTS")
slot_data_tbl <- tbl(conn1, "SLOT_DATA")
slot_data_prc_raw_tbl <- tbl(conn1, "ALL_SLOTS_PRC")
slot_data_prc_tbl <- tbl(conn1, "SLOT_DATA_PRC")

block_raw_tbl_loc <- tbl(conn1, "AVAIL_BLOCK")
block_name_tbl_loc <- tbl(conn1, "ZC_APPT_BLOCK")

#slot_view_tbl <- tbl(conn3, in_schema("OAO_PRODUCTION", "AMBULATORY_SLOT_TABLE"))


# Azure Connection ---------------------------------------------------
# access_raw_tbl <- tbl(conn5, in_schema("CLARITY", "MV_DM_PATIENT_ACCESS"))
# f_sched_appt_tbl <- tbl(conn5, dbplyr::ident_q('"CLARITY"."F_SCHED_APPT"'))
clarity_dep_conn <- tbl(conn5, dbplyr::ident_q('"Clarity"."CLARITY_DEP"'))

referrals_conn <- tbl(conn5, dbplyr::ident_q('"MS_SOLUTIONS_DEV"."y_s2_referrals_tmp"'))
caboodle_referrals_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralsDataView"'))
caboodle_referralFact_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralFact"'))
patient_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."PatientDim"'))
department_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."DepartmentDim"'))

clarity_referrals_tbl <- tbl(conn5, dbplyr::ident_q('"Clarity"."REFERRAL"'))

visitFact_conn <- tbl(conn5, dbplyr::ident_q('"Caboodle"."VisitFact"'))

```


```{r Report Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
date_start <- format(Sys.Date() +1, "%Y-%m-%d")
date_start_next30 <- format(Sys.Date() + 30, "%Y-%m-%d")
date_start_next90 <- format(Sys.Date() + 90, "%Y-%m-%d")

current_year <- format(report_run_date, "%Y")
prior_year <- as.character(as.numeric(current_year) -1)

current_month <- format(report_run_date, "%m")

current_year_month <- paste0(current_year,"-",current_month)


```


```{r New Patient Blocks, echo = FALSE, warning = FALSE, message = FALSE}
new_blocks <- c(
  "GMA New Pt",
  "Endo New Patient",
  "Covid New Patient",
  "Concussion New",
  "GYN NEW PT",
  "Hematology New Patient",
  "Initial Eval/New",
  "Lymphedema New",
  "Medicare Wellness - New",
  "New Cancer Patient",
  "NEW EAR",
  "New Lar",
  "New Patient Continued",
  "New Patient Extended",
  "New Patient freeze",
  "New Patient Only",
  "New Patient pt",
  "New Patient Start",
  "NEW PATIENT-GERIATRICS",
  "NEW RUNNING EVAL",
  "New Vertigo Patient",
  "NEW VOICE MODIFICATION",
  "New/Follow-up",
  "New/Fup/Hyl",
  # "OB NEW PATIENT",
  "Onc PT New",
  "Oncology New Patient",
  "OPR Sports New",
  "PA GYN NEW",
  "PALL-NEW PT",
  "PEDS CONCUSSION NEW",
  "PEDS NEW",
  "PEDS ORTHO NEW",
  "Physical Exam - New",
  "SINUS NEW",
  "Sports New",
  "VESTIBULAR NEW",
  "Zocdoc New",
  "ALS NEW",
  "APOS NEW",
  "Autoimmune New",
  "CF NEW",
  "COVID-19 SCREENING IN OFFICE NEW PATIENT",
  "Initial Visit",
  "New Pt - Straight Medicare",
  "NEW SELIKOFF",
  "OPR New Patient",
  "WOMEN'S SPORTS PT NEW",
  "New Patient pt",
  "New Patient Start",
  "New Patient 14-Day",
  "New Patient 21-Day",
  "New Patient 28-Day",
  "New Patient 7-Day",
  "NEW GYN 7-DAY",
  "NEW GYN 14-DAY",
  "NEW GYN 21-DAY",
  "NEW GYN 28-DAY",
  "Pregnancy Confirmation",
  "PEDS DERM NEW PATIENT 7",
  "PEDS DERM NEW PATIENT 14",
  "PEDS DERM NEW PATIENT 21",
  "PEDS DERM NEW PATIENT 28",
  "PAL CARE NEW PATIENT 7",
  "Annual Well New Pt",
  "Total Body New"
)

release_blocks <- c(
  "New Patient 14-Day",
  # "New Patient 21-Day",
  # "New Patient 28-Day",
  "New Patient 7-Day",
  "NEW GYN 7-DAY",
  "NEW GYN 14-DAY",
  # "NEW GYN 21-DAY",
  # "NEW GYN 28-DAY",
  "Pregnancy Confirmation",
  "PEDS DERM NEW PATIENT 7",
  "PEDS DERM NEW PATIENT 14",
  # "PEDS DERM NEW PATIENT 21",
  # "PEDS DERM NEW PATIENT 28",
  "PAL CARE NEW PATIENT 7"
)
release_blocks_all <- c(
  "New Patient 14-Day",
  "New Patient 21-Day",
  "New Patient 28-Day",
  "New Patient 7-Day",
  "NEW GYN 7-DAY",
  "NEW GYN 14-DAY",
  "NEW GYN 21-DAY",
  "NEW GYN 28-DAY",
  "Pregnancy Confirmation",
  "PEDS DERM NEW PATIENT 7",
  "PEDS DERM NEW PATIENT 14",
  "PEDS DERM NEW PATIENT 21",
  "PEDS DERM NEW PATIENT 28",
  "PAL CARE NEW PATIENT 7"
)

non_release_new_blocks <- setdiff(new_blocks, release_blocks_all)

```


```{r Process slot data, echo = FALSE, warning = FALSE, message = FALSE}

# Block Usage ------------------------------------------------------------------
org_block_type <- block_raw_tbl_loc %>%
  left_join(block_name_tbl_loc %>% 
              dplyr::select(APPT_BLOCK_C, NAME) %>%
              rename("APPT_BLOCK_NAME" = NAME),
            by = c("BLOCK_C" = "APPT_BLOCK_C")) %>%
  left_join(block_name_tbl_loc %>% 
              dplyr::select(APPT_BLOCK_C, NAME) %>%
              rename("REL_BLOCK_NAME" = NAME),
            by = c("REL_BLOCK_C" = "APPT_BLOCK_C")) %>%
  mutate(FINAL_BLOCK_NAME = case_when(is.na(REL_BLOCK_NAME) ~ APPT_BLOCK_NAME, TRUE ~ REL_BLOCK_NAME)) %>%
  mutate(BLOCK_RELEASE_ALL = case_when(FINAL_BLOCK_NAME %in% release_blocks_all ~ 1, TRUE ~ 0),
         BLOCK_RELEASE = case_when(FINAL_BLOCK_NAME %in% release_blocks ~ 1, TRUE ~ 0),
         BLOCK_NEW = case_when(FINAL_BLOCK_NAME %in% non_release_new_blocks ~ 1, TRUE ~ 0),
         BLOCK_OTHER = case_when(BLOCK_RELEASE_ALL == 0 & BLOCK_NEW == 0 ~ 1, TRUE ~ 0)) %>%
  arrange(DEPARTMENT_ID, SLOT_BEGIN_TIME, PROV_ID, FINAL_BLOCK_NAME) %>%
  group_by(DEPARTMENT_ID, SLOT_BEGIN_TIME, PROV_ID) %>%
  summarise(FINAL_BLOCKS = sql("LISTAGG(DISTINCT FINAL_BLOCK_NAME, ' , ')"),
            BLOCK_RELEASE_ALL_NUM = sum(BLOCK_RELEASE_ALL),
            BLOCK_RELEASE_NUM = sum(BLOCK_RELEASE),
            BLOCK_NEW_NUM = sum(BLOCK_NEW),
            BLOCK_OTHER_NUM = sum(BLOCK_OTHER)) %>%
  mutate(BLOCK_RELEASE_ALL_YN = case_when(BLOCK_RELEASE_ALL_NUM>0 ~ 1, TRUE ~ 0), 
         BLOCK_RELEASE_YN = case_when(BLOCK_RELEASE_NUM>0 ~ 1, TRUE ~ 0), 
         BLOCK_NEW_YN = case_when(BLOCK_NEW_NUM>0 ~ 1, TRUE ~ 0), 
         BLOCK_OTHER_YN = case_when(BLOCK_OTHER_NUM>0 ~ 1, TRUE ~ 0)) 


check <- slot_data_prc_tbl %>%
  group_by(year(SLOT_BEGIN_TIME), month(SLOT_BEGIN_TIME), DEPARTMENT_ID, PROV_ID, PROV_NM_WID) %>%
  summarise(total = n()) %>%
  collect()

block_distribution <- slot_data_prc_tbl %>%
  # filter(PROV_ID == "1325296") %>%
  # filter(DEPARTMENT_ID == "8274007") %>%
  filter(year(SLOT_BEGIN_TIME) >= current_year) %>%
   # filter(month(SLOT_BEGIN_TIME) >9) %>%
  # filter(month(SLOT_BEGIN_TIME) == 1) %>%
  left_join(org_block_type,
            by = c("DEPARTMENT_ID", "PROV_ID", "SLOT_BEGIN_TIME")) %>%
  left_join(clarity_ser_tbl_loc %>% 
              dplyr::select(PROV_ID, PROV_TYPE, ACTIVE_STATUS)) %>%
  # filter(PROV_TYPE == "Physician") %>%
  left_join(clarity_ser_2_tbl_loc %>% 
              dplyr::select(PROV_ID, GENERIC_YN)) %>%
  filter(GENERIC_YN == "N" |  is.na(GENERIC_YN)) %>%
  left_join(dep_mapping_tbl_loc %>%
              mutate(SITE = case_when(RPT_GRP_SEVNTEEN_C == 2 ~ "NETWORK", 
                                      RPT_GRP_SEVNTEEN_C == 3 ~ "OTHER", 
                                      RPT_GRP_SEVNTEEN_C == 4 ~ "MSH-MSDFP", 
                                      RPT_GRP_SEVNTEEN_C == 6 ~ "MSUS",
                                      RPT_GRP_SEVNTEEN_C == 7 ~ "MSDMG", 
                                      RPT_GRP_SEVNTEEN_C == 8 ~ "MSBI",
                                      RPT_GRP_SEVNTEEN_C == 9 ~ "MSW", 
                                      RPT_GRP_SEVNTEEN_C == 10 ~ "MSHP", 
                                      RPT_GRP_SEVNTEEN_C == 11 ~ "MSM", 
                                      RPT_GRP_SEVNTEEN_C == 12 ~ "MSH- AMBULATORY CARE",
                                      RPT_GRP_SEVNTEEN_C == 13 ~ "NYEE", 
                                      RPT_GRP_SEVNTEEN_C == 14 ~ "MS NOW", 
                                      RPT_GRP_SEVNTEEN_C == 15 ~ "MSQ", 
                                      RPT_GRP_SEVNTEEN_C == 19 ~ "MSSN", 
                                      RPT_GRP_SEVNTEEN_C == 38 ~ "MSB")) %>%
              dplyr::select(SITE, SPECIALTY, DEPARTMENT_ID) %>%
              rename("DEPT_SPECIALTY_NAME" = SPECIALTY),
            copy = T) %>%
  mutate(slot_year = year(SLOT_BEGIN_TIME),
         slot_month = month(SLOT_BEGIN_TIME)) %>%
  mutate(MSHS = "MSHS") 


future_block_distribution <- block_distribution %>%
  # filter(year(SLOT_BEGIN_TIME) == current_year) %>%
  filter(SLOT_BEGIN_TIME >= TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  group_by(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
           slot_year, slot_month) %>%
  summarise(avail_hour = sum(REG_AVAIL_MIN, na.rm = T)/60,
            sched_hour = sum(SCHED_MIN, na.rm = T)/60,
            arrived_hour = sum(ARRIVED_MIN, na.rm = T)/60,
            avail_hour_new = sum(REG_AVAIL_MIN[BLOCK_NEW_YN == 1])/60,
            sched_hour_new = sum(SCHED_MIN[BLOCK_NEW_YN == 1], na.rm = T)/60,
            arrived_hour_new = sum(ARRIVED_MIN[BLOCK_NEW_YN == 1], na.rm = T)/60,
            avail_hour_release = sum(REG_AVAIL_MIN[BLOCK_RELEASE_ALL_YN == 1])/60,
            sched_hour_release = sum(SCHED_MIN[BLOCK_RELEASE_ALL_YN == 1], na.rm = T)/60,
            arrived_hour_release = sum(ARRIVED_MIN[BLOCK_RELEASE_ALL_YN == 1], na.rm = T)/60,
            avail_hour_other = sum(REG_AVAIL_MIN[BLOCK_OTHER_YN == 1])/60,
            sched_hour_other = sum(SCHED_MIN[BLOCK_OTHER_YN == 1], na.rm = T)/60,
            arrived_hour_other = sum(ARRIVED_MIN[BLOCK_OTHER_YN == 1], na.rm = T)/60,
            reg_openings = sum(REG_AVAIL_OPENINGS),
            reg_openings_new_release = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 | BLOCK_NEW_YN == 1]),
            reg_openings_release_all = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1]),
            reg_openings_release = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_YN == 1]),
            reg_openings_new_normal = sum(REG_AVAIL_OPENINGS[BLOCK_NEW_YN == 1 & BLOCK_RELEASE_ALL_YN == 0 & BLOCK_OTHER_YN == 0]),
            reg_openings_new_combination = sum(REG_AVAIL_OPENINGS[BLOCK_NEW_YN == 1 & (BLOCK_RELEASE_ALL_YN == 1 | BLOCK_OTHER_YN == 1)]),
            reg_openings_release_normal = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 & BLOCK_NEW_YN == 0 & BLOCK_OTHER_YN == 0]),
            reg_openings_release_combination = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 & (BLOCK_NEW_YN == 1 | BLOCK_OTHER_YN == 1)])) %>%
  collect()


future_block_distribution <- past_block_distribution %>%
  mutate(perc_reg_openings_new_release = case_when(reg_openings == 0 | is.na(reg_openings) ~ 0, TRUE ~ reg_openings_new_release/reg_openings),
         perc_release_all = case_when(reg_openings_new_release == 0 | is.na(reg_openings_new_release) ~ 0, TRUE ~ reg_openings_release_all/reg_openings_new_release),
         perc_release = case_when(reg_openings_new_release == 0 | is.na(reg_openings_new_release) ~ 0, TRUE ~ reg_openings_release/reg_openings_new_release)) %>%
  # mutate(prov_util = case_when(avail_hour == 0 | is.na(avail_hour) ~ 0, TRUE ~ arrived_hour/avail_hour),
  #        prov_util_new = case_when(avail_hour_new == 0 | is.na(avail_hour_new) ~ 0, TRUE ~ arrived_hour_new/avail_hour_new),
  #        prov_util_release = case_when(avail_hour_release == 0 | is.na(avail_hour_release) ~ 0, TRUE ~ arrived_hour_release/avail_hour_release),
  #        prov_util_other = case_when(avail_hour_other == 0 | is.na(avail_hour_other) ~ 0, TRUE ~ arrived_hour_other/avail_hour_other)) %>%
  # filter(prov_util >=0.35 & prov_util <=2.0) %>%
  mutate(slot_year_month = as.character(paste0(slot_year, "-", ifelse(nchar(slot_month)==1,paste0("0",slot_month), slot_month))),
           slot_month = as.numeric(slot_month))  %>%
  relocate(slot_year_month, .after = slot_month)


past_block_distribution <- block_distribution %>%
  filter(year(SLOT_BEGIN_TIME) == current_year) %>%
  filter(SLOT_BEGIN_TIME <= TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  group_by(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
           slot_year, slot_month) %>%
  summarise(avail_hour = sum(REG_AVAIL_MIN, na.rm = T)/60,
            sched_hour = sum(SCHED_MIN, na.rm = T)/60,
            arrived_hour = sum(ARRIVED_MIN, na.rm = T)/60,
            avail_hour_new = sum(REG_AVAIL_MIN[BLOCK_NEW_YN == 1])/60,
            sched_hour_new = sum(SCHED_MIN[BLOCK_NEW_YN == 1], na.rm = T)/60,
            arrived_hour_new = sum(ARRIVED_MIN[BLOCK_NEW_YN == 1], na.rm = T)/60,
            avail_hour_release = sum(REG_AVAIL_MIN[BLOCK_RELEASE_ALL_YN == 1])/60,
            sched_hour_release = sum(SCHED_MIN[BLOCK_RELEASE_ALL_YN == 1], na.rm = T)/60,
            arrived_hour_release = sum(ARRIVED_MIN[BLOCK_RELEASE_ALL_YN == 1], na.rm = T)/60,
            avail_hour_other = sum(REG_AVAIL_MIN[BLOCK_OTHER_YN == 1])/60,
            sched_hour_other = sum(SCHED_MIN[BLOCK_OTHER_YN == 1], na.rm = T)/60,
            arrived_hour_other = sum(ARRIVED_MIN[BLOCK_OTHER_YN == 1], na.rm = T)/60,
            reg_openings = sum(REG_AVAIL_OPENINGS),
            reg_openings_new_release = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 | BLOCK_NEW_YN == 1]),
            reg_openings_release_all = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1]),
            reg_openings_release = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_YN == 1]),
            reg_openings_new_normal = sum(REG_AVAIL_OPENINGS[BLOCK_NEW_YN == 1 & BLOCK_RELEASE_ALL_YN == 0 & BLOCK_OTHER_YN == 0]),
            reg_openings_new_combination = sum(REG_AVAIL_OPENINGS[BLOCK_NEW_YN == 1 & (BLOCK_RELEASE_ALL_YN == 1 | BLOCK_OTHER_YN == 1)]),
            reg_openings_release_normal = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 & BLOCK_NEW_YN == 0 & BLOCK_OTHER_YN == 0]),
            reg_openings_release_combination = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1 & (BLOCK_NEW_YN == 1 | BLOCK_OTHER_YN == 1)])) %>%
  collect()


past_block_distribution <- past_block_distribution %>%
  mutate(perc_reg_openings_new_release = case_when(reg_openings == 0 | is.na(reg_openings) ~ 0, TRUE ~ reg_openings_new_release/reg_openings),
         perc_release_all = case_when(reg_openings_new_release == 0 | is.na(reg_openings_new_release) ~ 0, TRUE ~ reg_openings_release_all/reg_openings_new_release),
         perc_release = case_when(reg_openings_new_release == 0 | is.na(reg_openings_new_release) ~ 0, TRUE ~ reg_openings_release/reg_openings_new_release)) %>%
  mutate(prov_util = case_when(avail_hour == 0 | is.na(avail_hour) ~ 0, TRUE ~ arrived_hour/avail_hour),
         prov_util_new = case_when(avail_hour_new == 0 | is.na(avail_hour_new) ~ 0, TRUE ~ arrived_hour_new/avail_hour_new),
         prov_util_release = case_when(avail_hour_release == 0 | is.na(avail_hour_release) ~ 0, TRUE ~ arrived_hour_release/avail_hour_release),
         prov_util_other = case_when(avail_hour_other == 0 | is.na(avail_hour_other) ~ 0, TRUE ~ arrived_hour_other/avail_hour_other)) %>%
  filter(prov_util >=0.35 & prov_util <=2.0) %>%
  mutate(slot_year_month = as.character(paste0(slot_year, "-", ifelse(nchar(slot_month)==1,paste0("0",slot_month), slot_month))),
           slot_month = as.numeric(slot_month))  %>%
  relocate(slot_year_month, .after = slot_month)


# Individual/Combination Blocks next 90 Days ------------------------------------
block_error <- slot_data_prc_tbl %>%
  # filter(year(SLOT_BEGIN_TIME) == current_year) %>%
  filter(SLOT_BEGIN_TIME >= TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(SLOT_BEGIN_TIME <= TO_DATE(date_start_next30, "YYYY-MM-DD HH24:MI:SS")) %>%
  # filter(PROV_ID == "449366") %>%
  # filter(PROV_ID == "1410756") %>%
  # filter(DEPARTMENT_ID == "8827031") %>%
  left_join(org_block_type,
            by = c("DEPARTMENT_ID", "PROV_ID", "SLOT_BEGIN_TIME")) %>%
  left_join(clarity_ser_tbl_loc %>%
              dplyr::select(PROV_ID, PROV_TYPE, ACTIVE_STATUS)) %>%
  # filter(PROV_TYPE == "Physician") %>%
  left_join(clarity_ser_2_tbl_loc %>%
              dplyr::select(PROV_ID, GENERIC_YN)) %>%
  filter(GENERIC_YN == "N" |  is.na(GENERIC_YN)) %>%
  left_join(dep_mapping_tbl_loc %>%
              mutate(SITE = case_when(RPT_GRP_SEVNTEEN_C == 2 ~ "NETWORK",
                                      RPT_GRP_SEVNTEEN_C == 3 ~ "OTHER",
                                      RPT_GRP_SEVNTEEN_C == 4 ~ "MSH-MSDFP",
                                      RPT_GRP_SEVNTEEN_C == 6 ~ "MSUS",
                                      RPT_GRP_SEVNTEEN_C == 7 ~ "MSDMG",
                                      RPT_GRP_SEVNTEEN_C == 8 ~ "MSBI",
                                      RPT_GRP_SEVNTEEN_C == 9 ~ "MSW",
                                      RPT_GRP_SEVNTEEN_C == 10 ~ "MSHP", 
                                      RPT_GRP_SEVNTEEN_C == 11 ~ "MSM",
                                      RPT_GRP_SEVNTEEN_C == 12 ~ "MSH- AMBULATORY CARE",
                                      RPT_GRP_SEVNTEEN_C == 13 ~ "NYEE",
                                      RPT_GRP_SEVNTEEN_C == 14 ~ "MS NOW",
                                      RPT_GRP_SEVNTEEN_C == 15 ~ "MSQ",
                                      RPT_GRP_SEVNTEEN_C == 19 ~ "MSSN",
                                      RPT_GRP_SEVNTEEN_C == 38 ~ "MSB")) %>%
              dplyr::select(SITE, SPECIALTY, DEPARTMENT_ID) %>%
              rename("DEPT_SPECIALTY_NAME" = SPECIALTY),
            copy = T) %>%
  mutate(slot_year = year(SLOT_BEGIN_TIME),
         slot_month = month(SLOT_BEGIN_TIME)) %>%
  mutate(slot_date = sql("TRUNC(SLOT_BEGIN_TIME)"),
         slot_week = sql("TRUNC(SLOT_BEGIN_TIME, 'IW')"),
         slot_day_num = sql("TO_CHAR(SLOT_BEGIN_TIME, 'D')"),
         slot_day = sql("TO_CHAR(SLOT_BEGIN_TIME, 'DY')")) %>%
  mutate(MSHS = "MSHS") %>%
  mutate(incorrect_blocks = BLOCK_RELEASE_ALL_YN + BLOCK_NEW_YN + BLOCK_OTHER_YN)


block_error <- block_error %>%
  group_by(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
           slot_year, slot_month, slot_week, slot_day_num, slot_day, FINAL_BLOCKS) %>%
  summarise(reg_openings = sum(REG_AVAIL_OPENINGS),
            reg_openings_new = sum(REG_AVAIL_OPENINGS[BLOCK_NEW_YN == 1]),
            reg_openings_release = sum(REG_AVAIL_OPENINGS[BLOCK_RELEASE_ALL_YN == 1]),
            reg_openings_other = sum(REG_AVAIL_OPENINGS[BLOCK_OTHER_YN == 1]),
            incorrect_openings = sum(REG_AVAIL_OPENINGS[incorrect_blocks > 1])) %>%
  ungroup() %>%
  mutate(perc_incorrect_openings = case_when(reg_openings == 0 | is.na(reg_openings) ~ 0, TRUE ~ incorrect_openings/reg_openings)) %>%
  collect() %>%
  mutate(slot_year_month = as.character(paste0(slot_year, "-", ifelse(nchar(slot_month)==1,paste0("0",slot_month), slot_month))),
           slot_week = as.character(slot_week),
           slot_month = as.numeric(slot_month))



# Open Slots in next 30 days ---------------------------------------------------
open_slots <- slot_data_prc_tbl %>%
  # filter(year(SLOT_BEGIN_TIME) == current_year) %>%
  filter(SLOT_BEGIN_TIME >= TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(SLOT_BEGIN_TIME <= TO_DATE(date_start_next30, "YYYY-MM-DD HH24:MI:SS")) %>%
  # filter(PROV_ID == "1410756") %>%
  # filter(DEPARTMENT_ID == "8827031") %>%
  left_join(org_block_type,
            by = c("DEPARTMENT_ID", "PROV_ID", "SLOT_BEGIN_TIME")) %>%
  left_join(clarity_ser_tbl_loc %>%
              dplyr::select(PROV_ID, PROV_TYPE, ACTIVE_STATUS)) %>%
  # filter(PROV_TYPE == "Physician") %>%
  left_join(clarity_ser_2_tbl_loc %>%
              dplyr::select(PROV_ID, GENERIC_YN)) %>%
  filter(GENERIC_YN == "N" |  is.na(GENERIC_YN)) %>%
  left_join(dep_mapping_tbl_loc %>%
              mutate(SITE = case_when(RPT_GRP_SEVNTEEN_C == 2 ~ "NETWORK",
                                      RPT_GRP_SEVNTEEN_C == 3 ~ "OTHER",
                                      RPT_GRP_SEVNTEEN_C == 4 ~ "MSH-MSDFP",
                                      RPT_GRP_SEVNTEEN_C == 6 ~ "MSUS",
                                      RPT_GRP_SEVNTEEN_C == 7 ~ "MSDMG",
                                      RPT_GRP_SEVNTEEN_C == 8 ~ "MSBI",
                                      RPT_GRP_SEVNTEEN_C == 9 ~ "MSW",
                                      RPT_GRP_SEVNTEEN_C == 10 ~ "MSHP",
                                      RPT_GRP_SEVNTEEN_C == 11 ~ "MSM",
                                      RPT_GRP_SEVNTEEN_C == 12 ~ "MSH- AMBULATORY CARE",
                                      RPT_GRP_SEVNTEEN_C == 13 ~ "NYEE",
                                      RPT_GRP_SEVNTEEN_C == 14 ~ "MS NOW",
                                      RPT_GRP_SEVNTEEN_C == 15 ~ "MSQ",
                                      RPT_GRP_SEVNTEEN_C == 19 ~ "MSSN",
                                      RPT_GRP_SEVNTEEN_C == 38 ~ "MSB")) %>%
              dplyr::select(SITE, SPECIALTY, DEPARTMENT_ID) %>%
              rename("DEPT_SPECIALTY_NAME" = SPECIALTY),
            copy = T) %>%
  mutate(slot_year = year(SLOT_BEGIN_TIME),
         slot_month = month(SLOT_BEGIN_TIME)) %>%
  mutate(slot_date = sql("TRUNC(SLOT_BEGIN_TIME)"),
         slot_week = sql("TRUNC(SLOT_BEGIN_TIME, 'IW')"),
         slot_day_num = sql("TO_CHAR(SLOT_BEGIN_TIME, 'D')"),
         slot_day = sql("TO_CHAR(SLOT_BEGIN_TIME, 'DY')")) %>%
  mutate(MSHS = "MSHS")


open_slots_summary <- open_slots %>%
  group_by(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
           slot_year, slot_month, slot_date) %>%
  summarise(reg_openings = sum(REG_AVAIL_OPENINGS),
            sched_num = sum(SCHED_NUM),
            avail_min = sum(REG_AVAIL_MIN),
            sched_min = sum(SCHED_MIN)) %>%
  mutate(unused_num = case_when(reg_openings - sched_num >0 ~ reg_openings - sched_num, TRUE ~ 0),
         unused_min = case_when(avail_min - sched_min >0 ~ avail_min - sched_min, TRUE ~ 0)) %>%
  mutate(perc_num_open = case_when(reg_openings == 0 | is.na(reg_openings) ~ 0, TRUE ~ sched_num/reg_openings),
         perc_min_open = case_when(avail_min == 0 | is.na(avail_min) ~ 0, TRUE ~ sched_min/avail_min)) %>%
  collect() %>%
  mutate(slot_year_month = as.character(paste0(slot_year, "-", ifelse(nchar(slot_month)==1,paste0("0",slot_month), slot_month))),
           slot_month = as.numeric(slot_month))


# open_slots_detail <- open_slots %>%
#   group_by(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
#            slot_year, slot_month, slot_date, SLOT_BEGIN_TIME, FINAL_BLOCKS) %>%
#   mutate(reg_openings = sum(REG_AVAIL_OPENINGS),
#             sched_num = sum(SCHED_NUM),
#             avail_min = sum(REG_AVAIL_MIN),
#             sched_min = sum(SCHED_MIN)) %>%
#   mutate(unused_num = reg_openings - sched_num,
#          unused_min = avail_min - sched_min) %>%
#   filter((unused_num)>=1) %>%
#   dplyr::select(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, PROV_NM_WID, PROV_TYPE, ACTIVE_STATUS,
#            slot_year, slot_month, slot_date, SLOT_BEGIN_TIME, FINAL_BLOCKS, SLOT_LENGTH, REG_AVAIL_OPENINGS, sched_num, REG_AVAIL_MIN, SCHED_MIN) %>%
#   collect() %>%
#   mutate(slot_year_month = as.character(paste0(slot_year, "-", ifelse(nchar(slot_month)==1,paste0("0",slot_month), slot_month))),
#            slot_month = as.numeric(slot_month))


```


```{r Sinai Logo, echo=FALSE, out.width = '15%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Template Block Usage Report {.tabset .tabset-fade .tabset-pills}
*Report run date: `r report_run_date`*<br/>
______________________________________________________________________________________________________________________________
<br/>
<br/>

## Upcoming Block Distribution (Physicians Only)
```{r Upcoming Block Usage (Physicians), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('future-block-distribution-physician', 'Upcoming Template Block Distribution')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "block-distribution-physician")),
#     tags$select(
#       id = "block-distribution-physician",
#       onchange = "Reactable.setGroupBy('block-distribution-physician', this.value ? [this.value] : [])",
#       tags$option("None", value = c("SITE","slot_year_month")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Site", "Year-Month"), tags$option)
#     ),
    
reactable(
  future_block_distribution %>%
    arrange(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year, slot_month) %>%
    filter(PROV_TYPE == "Physician"),
  elementId = "future-block-distribution-physician",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_TYPE"),
  
  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS", "slot_year_month"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "reg_openings_new_release", "perc_reg_openings_new_release"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Non-Late-Releasing New Openings"),
             columns = c("reg_openings_new_normal", "reg_openings_new_combination"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Late-Releasing New Openings"),
             columns = c("reg_openings_release_normal", "reg_openings_release_combination", "perc_release_all", "perc_release"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px"))
    ),
  
  columns = list(
    
    SITE = colDef(
      name = "Site",
      minWidth = 150),
    
    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),
    
    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),
    
    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),
    
    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),
    
    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),
    
    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),
    
    reg_openings = colDef(
      name = "All Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_release = colDef(
      name = "New* Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_reg_openings_new_release = colDef(
      name = "% New* Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_new_release) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    reg_openings_new_normal = colDef(
      name = "Individual Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_combination = colDef(
      name = "Combination Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    reg_openings_release_normal = colDef(
      name = "Individual Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_release_combination = colDef(
      name = "Combination Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_release_all = colDef(
      name = "% All Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release_all = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release_all += row['reg_openings_release_all']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release_all) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_release = colDef(
      name = "% 7/14-Day Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release += row['reg_openings_release']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    avail_hour = colDef(show =F),
    sched_hour = colDef(show =F),
    arrived_hour = colDef(show =F),
    avail_hour_new = colDef(show =F),
    sched_hour_new = colDef(show =F),
    arrived_hour_new = colDef(show =F),
    avail_hour_release = colDef(show =F),
    sched_hour_release = colDef(show =F),
    arrived_hour_release = colDef(show =F),
    avail_hour_other = colDef(show =F),
    sched_hour_other = colDef(show =F),
    arrived_hour_other = colDef(show =F),
    reg_openings_release_all = colDef(show =F),
    reg_openings_release = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<p style="font-size:10pt; font-style:italic">*New openings include both non-time-releasing and time-releasing new block openings.<p/>
<br/>


## Upcoming Block Distribution (All Providers)
```{r Upcoming Block Usage (All), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('future-block-distribution', 'Upcoming Template Block Distribution')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "block-distribution-physician")),
#     tags$select(
#       id = "block-distribution-physician",
#       onchange = "Reactable.setGroupBy('block-distribution-physician', this.value ? [this.value] : [])",
#       tags$option("None", value = c("SITE","slot_year_month")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Site", "Year-Month"), tags$option)
#     ),
    
reactable(
  future_block_distribution %>%
    arrange(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year, slot_month),
    # filter(PROV_TYPE == "Physician"),
  elementId = "future-block-distribution",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_TYPE"),
  
  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS", "slot_year_month"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "reg_openings_new_release", "perc_reg_openings_new_release"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Non-Late-Releasing New Openings"),
             columns = c("reg_openings_new_normal", "reg_openings_new_combination"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Late-Releasing New Openings"),
             columns = c("reg_openings_release_normal", "reg_openings_release_combination", "perc_release_all", "perc_release"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px"))
  # colGroup(name = paste0("Provider Utilization**"),
  #            columns = c("prov_util", "prov_util_new", "prov_util_release", "prov_util_other"),
  #          headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px"))
    ),
  
  columns = list(
    
    SITE = colDef(
      name = "Site",
      minWidth = 150),
    
    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),
    
    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),
    
    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),
    
    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),
    
    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),
    
    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),
    
    reg_openings = colDef(
      name = "All Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_release = colDef(
      name = "New* Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_reg_openings_new_release = colDef(
      name = "% New* Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_new_release) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    reg_openings_new_normal = colDef(
      name = "Individual Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_combination = colDef(
      name = "Combination Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    reg_openings_release_normal = colDef(
      name = "Individual Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_release_combination = colDef(
      name = "Combination Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_release_all = colDef(
      name = "% All Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release_all = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release_all += row['reg_openings_release_all']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release_all) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_release = colDef(
      name = "% 7/14-Day Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release += row['reg_openings_release']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    avail_hour = colDef(show =F),
    sched_hour = colDef(show =F),
    arrived_hour = colDef(show =F),
    avail_hour_new = colDef(show =F),
    sched_hour_new = colDef(show =F),
    arrived_hour_new = colDef(show =F),
    avail_hour_release = colDef(show =F),
    sched_hour_release = colDef(show =F),
    arrived_hour_release = colDef(show =F),
    avail_hour_other = colDef(show =F),
    sched_hour_other = colDef(show =F),
    arrived_hour_other = colDef(show =F),
    reg_openings_release_all = colDef(show =F),
    reg_openings_release = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)


```
<br/>
<p style="font-size:10pt; font-style:italic">*New openings include both non-time-releasing and time-releasing new block openings.<p/>
<br/>


## Past Block Distribution (Physicians Only)
```{r Past Block Usage (Physicians), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('past-block-distribution-physician', 'Past Template Block Distribution')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "block-distribution-physician")),
#     tags$select(
#       id = "block-distribution-physician",
#       onchange = "Reactable.setGroupBy('block-distribution-physician', this.value ? [this.value] : [])",
#       tags$option("None", value = c("SITE","slot_year_month")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Site", "Year-Month"), tags$option)
#     ),
    
reactable(
  past_block_distribution %>%
    arrange(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year, slot_month) %>%
    filter(PROV_TYPE == "Physician"),
  elementId = "past-block-distribution-physician",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_TYPE"),
  
  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS", "slot_year_month"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "reg_openings_new_release", "perc_reg_openings_new_release"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Non-Late-Releasing New Openings"),
             columns = c("reg_openings_new_normal", "reg_openings_new_combination"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Late-Releasing New Openings"),
             columns = c("reg_openings_release_normal", "reg_openings_release_combination", "perc_release_all", "perc_release"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
  colGroup(name = paste0("Provider Utilization**"),
             columns = c("prov_util", "prov_util_new", "prov_util_release", "prov_util_other"),
           headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px"))
    ),
  
  columns = list(
    
    SITE = colDef(
      name = "Site",
      minWidth = 150),
    
    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),
    
    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),
    
    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),
    
    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),
    
    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),
    
    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),
    
    reg_openings = colDef(
      name = "All Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_release = colDef(
      name = "New* Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_reg_openings_new_release = colDef(
      name = "% New* Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_new_release) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    reg_openings_new_normal = colDef(
      name = "Individual Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_combination = colDef(
      name = "Combination Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    reg_openings_release_normal = colDef(
      name = "Individual Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_release_combination = colDef(
      name = "Combination Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_release_all = colDef(
      name = "% All Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release_all = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release_all += row['reg_openings_release_all']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release_all) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_release = colDef(
      name = "% 7/14-Day Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release += row['reg_openings_release']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    
    prov_util = colDef(
      name = "All Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour = 0
        let totalarrived_hour = 0
        rows.forEach(function(row) {
          totalavail_hour += row['avail_hour']
          totalarrived_hour += row['arrived_hour']
        })
        return (totalarrived_hour) / (totalavail_hour) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    prov_util_new = colDef(
      name = "Individual/ Combination Non-Late-Releasing New",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_new = 0
        let totalarrived_hour_new = 0
        rows.forEach(function(row) {
          totalavail_hour_new += row['avail_hour_new']
          totalarrived_hour_new += row['arrived_hour_new']
        })
        return (totalarrived_hour_new) / (totalavail_hour_new) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    prov_util_release = colDef(
      name = "Individual/ Combination Late-Releasing New",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_release = 0
        let totalarrived_hour_release = 0
        rows.forEach(function(row) {
          totalavail_hour_release += row['avail_hour_release']
          totalarrived_hour_release += row['arrived_hour_release']
        })
        return (totalarrived_hour_release) / (totalavail_hour_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    prov_util_other = colDef(
      name = "Individual/ Combination Other",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_other = 0
        let totalarrived_hour_other = 0
        rows.forEach(function(row) {
          totalavail_hour_other += row['avail_hour_other']
          totalarrived_hour_other += row['arrived_hour_other']
        })
        return (totalarrived_hour_other) / (totalavail_hour_other) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    avail_hour = colDef(show =F),
    sched_hour = colDef(show =F),
    arrived_hour = colDef(show =F),
    avail_hour_new = colDef(show =F),
    sched_hour_new = colDef(show =F),
    arrived_hour_new = colDef(show =F),
    avail_hour_release = colDef(show =F),
    sched_hour_release = colDef(show =F),
    arrived_hour_release = colDef(show =F),
    avail_hour_other = colDef(show =F),
    sched_hour_other = colDef(show =F),
    arrived_hour_other = colDef(show =F),
    reg_openings_release_all = colDef(show =F),
    reg_openings_release = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<p style="font-size:10pt; font-style:italic">*New openings include both non-time-releasing and time-releasing new block openings.<p/>
<p style="font-size:10pt; font-style:italic">**Provider utilization for combination blocks are double counted.<p/>
<br/>


## Past Block Distribution (All Providers)
```{r Past Block Usage, echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('past-block-distribution', 'Past Template Block Distribution')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "block-distribution-physician")),
#     tags$select(
#       id = "block-distribution-physician",
#       onchange = "Reactable.setGroupBy('block-distribution-physician', this.value ? [this.value] : [])",
#       tags$option("None", value = c("SITE","slot_year_month")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Site", "Year-Month"), tags$option)
#     ),
    
reactable(
  past_block_distribution %>%
    arrange(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year, slot_month),
    # filter(PROV_TYPE == "Physician"),
  elementId = "past-block-distribution",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_TYPE"),
  
  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS", "slot_year_month"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "reg_openings_new_release", "perc_reg_openings_new_release"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Non-Late-Releasing New Openings"),
             columns = c("reg_openings_new_normal", "reg_openings_new_combination"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Late-Releasing New Openings"),
             columns = c("reg_openings_release_normal", "reg_openings_release_combination", "perc_release_all", "perc_release"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
  colGroup(name = paste0("Provider Utilization**"),
             columns = c("prov_util", "prov_util_new", "prov_util_release", "prov_util_other"),
           headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px"))
    ),
  
  columns = list(
    
    SITE = colDef(
      name = "Site",
      minWidth = 150),
    
    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),
    
    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),
    
    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),
    
    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),
    
    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),
    
    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),
    
    reg_openings = colDef(
      name = "All Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_release = colDef(
      name = "New* Blocks",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_reg_openings_new_release = colDef(
      name = "% New* Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_new_release) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    reg_openings_new_normal = colDef(
      name = "Individual Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_new_combination = colDef(
      name = "Combination Non-Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    reg_openings_release_normal = colDef(
      name = "Individual Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),

    reg_openings_release_combination = colDef(
      name = "Combination Late-Releasing",
      aggregate = 'sum',
      minWidth = 80,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    perc_release_all = colDef(
      name = "% All Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release_all = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release_all += row['reg_openings_release_all']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release_all) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_release = colDef(
      name = "% 7/14-Day Late-Releasing of New Openings",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings_release = 0
        let totalreg_openings_new_release = 0
        rows.forEach(function(row) {
          totalreg_openings_release += row['reg_openings_release']
          totalreg_openings_new_release += row['reg_openings_new_release']
        })
        return (totalreg_openings_release) / (totalreg_openings_new_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    
    prov_util = colDef(
      name = "All Blocks",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour = 0
        let totalarrived_hour = 0
        rows.forEach(function(row) {
          totalavail_hour += row['avail_hour']
          totalarrived_hour += row['arrived_hour']
        })
        return (totalarrived_hour) / (totalavail_hour) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    prov_util_new = colDef(
      name = "Individual/ Combination Non-Late-Releasing New",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_new = 0
        let totalarrived_hour_new = 0
        rows.forEach(function(row) {
          totalavail_hour_new += row['avail_hour_new']
          totalarrived_hour_new += row['arrived_hour_new']
        })
        return (totalarrived_hour_new) / (totalavail_hour_new) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    prov_util_release = colDef(
      name = "Individual/ Combination Late-Releasing New",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_release = 0
        let totalarrived_hour_release = 0
        rows.forEach(function(row) {
          totalavail_hour_release += row['avail_hour_release']
          totalarrived_hour_release += row['arrived_hour_release']
        })
        return (totalarrived_hour_release) / (totalavail_hour_release) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),
    
    prov_util_other = colDef(
      name = "Individual/ Combination Other",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hour_other = 0
        let totalarrived_hour_other = 0
        rows.forEach(function(row) {
          totalavail_hour_other += row['avail_hour_other']
          totalarrived_hour_other += row['arrived_hour_other']
        })
        return (totalarrived_hour_other) / (totalavail_hour_other) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    avail_hour = colDef(show =F),
    sched_hour = colDef(show =F),
    arrived_hour = colDef(show =F),
    avail_hour_new = colDef(show =F),
    sched_hour_new = colDef(show =F),
    arrived_hour_new = colDef(show =F),
    avail_hour_release = colDef(show =F),
    sched_hour_release = colDef(show =F),
    arrived_hour_release = colDef(show =F),
    avail_hour_other = colDef(show =F),
    sched_hour_other = colDef(show =F),
    arrived_hour_other = colDef(show =F),
    reg_openings_release_all = colDef(show =F),
    reg_openings_release = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<p style="font-size:10pt; font-style:italic">*New openings include both non-time-releasing and time-releasing new block openings.<p/>
<p style="font-size:10pt; font-style:italic">**Provider utilization for combination blocks are double counted.<p/>
<br/>

## Combination Blocks (Physicians Only)
*Includes slots from `r date_start` to `r date_start_next30`*<br/>
```{r Combination Blocks (Physicians), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('combination-blocks-physician', 'Block Combinations')"
    ),
# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "cars-grouping-select")),
#     tags$select(
#       id = "cars-grouping-select",
#       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])",
#       tags$option("None", value = c("Campus","Campus.Specialty.Group")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#     ),
#
#     tags$hr("aria-hidden" = "true"),
reactable(
  block_error %>%
    arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year_month, slot_week, slot_day) %>%
    filter(PROV_TYPE == "Physician"),
  elementId = "combination-blocks-physician",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "PROV_NM_WID"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS",
                                    "slot_week", "slot_day", "FINAL_BLOCKS"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "incorrect_openings", "perc_incorrect_openings"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px"))
    ),

  columns = list(

    SITE = colDef(
      name = "Site",
      minWidth = 150),

    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),

    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),

    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),

    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),

    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),

    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),

    slot_week = colDef(
      name = "Week",
      minWidth = 100),
    
    slot_day = colDef(
      name = "Day",
      minWidth = 100),

    FINAL_BLOCKS = colDef(
      name = "Blocks Assigned",
      minWidth = 250),

    reg_openings = colDef(
      name = "Total Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    incorrect_openings = colDef(
      name = "Combination Block Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),


    perc_incorrect_openings = colDef(
      name = "% Combination Block Openings",
      maxWidth = 200,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = list(color = "#e00000", fontWeight = "Bold"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalincorrect_openings = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalincorrect_openings += row['incorrect_openings']
        })
        return (totalincorrect_openings) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    slot_day_num = colDef(show =F),
    reg_openings_new = colDef(show =F),
    reg_openings_release = colDef(show =F),
    reg_openings_other = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<br/>


## Combination Blocks (All Providers)
*Includes slots from `r date_start` to `r date_start_next30`*<br/>
```{r Combination Blocks (All), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('combination-blocks', 'Block Combinations')"
    ),
# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "cars-grouping-select")),
#     tags$select(
#       id = "cars-grouping-select",
#       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])",
#       tags$option("None", value = c("Campus","Campus.Specialty.Group")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#     ),
#
#     tags$hr("aria-hidden" = "true"),
reactable(
  block_error %>%
    arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, PROV_TYPE, PROV_NM_WID, slot_year_month, slot_week, slot_day),
    # filter(PROV_TYPE == "Physician"),
  elementId = "combination-blocks",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "PROV_NM_WID"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS",
                                    "slot_week", "slot_day", "FINAL_BLOCKS"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Total Openings"),
             columns = c("reg_openings", "incorrect_openings", "perc_incorrect_openings"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px"))
    ),

  columns = list(

    SITE = colDef(
      name = "Site",
      minWidth = 150),

    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),

    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),

    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),

    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),

    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),

    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),

    slot_week = colDef(
      name = "Week",
      minWidth = 100),
    
    slot_day = colDef(
      name = "Day",
      minWidth = 100),

    FINAL_BLOCKS = colDef(
      name = "Blocks Assigned",
      minWidth = 250),

    reg_openings = colDef(
      name = "Total Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),

    incorrect_openings = colDef(
      name = "Combination Block Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),


    perc_incorrect_openings = colDef(
      name = "% Combination Block Openings",
      maxWidth = 200,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = list(color = "#e00000", fontWeight = "Bold"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalreg_openings = 0
        let totalincorrect_openings = 0
        rows.forEach(function(row) {
          totalreg_openings += row['reg_openings']
          totalincorrect_openings += row['incorrect_openings']
        })
        return (totalincorrect_openings) / (totalreg_openings) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    slot_day_num = colDef(show =F),
    reg_openings_new = colDef(show =F),
    reg_openings_release = colDef(show =F),
    reg_openings_other = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)


```
<br/>
<br/>


## Unused Slots (Physicians Only)
*Includes slots from `r date_start` to `r date_start_next30`*<br/>
```{r Unused Slots Summary (Physicians), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('unused-slots-summary-physician', 'Block Combinations')"
    ),
# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "cars-grouping-select")),
#     tags$select(
#       id = "cars-grouping-select",
#       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])",
#       tags$option("None", value = c("Campus","Campus.Specialty.Group")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#     ),
#
#     tags$hr("aria-hidden" = "true"),
reactable(
  open_slots_summary %>%
    mutate(slot_date = as.character(slot_date)) %>%
    arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, slot_year_month, slot_date) %>%
    filter(PROV_TYPE == "Physician"),
  elementId = "unused-slots-summary-physician",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Slot Openings"),
             columns = c("reg_openings", "sched_num", "unused_num"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Slot Minutes"),
             columns = c("avail_min", "sched_min", "unused_min"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px"))
    ),

  columns = list(

    SITE = colDef(
      name = "Site",
      minWidth = 150),

    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),

    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),

    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),

    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),

    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),

    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),

    slot_date = colDef(
      name = "Slot Date",
      minWidth = 100),
  
    reg_openings = colDef(
      name = "Available Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    sched_num = colDef(
      name = "Scheduled Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    unused_num = colDef(
      name = "Unused Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['unused_num']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }")),
    
    avail_min = colDef(
      name = "Available Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    sched_min = colDef(
      name = "Scheduled Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    unused_min = colDef(
      name = "Unused Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['unused_num']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }")),


    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    perc_num_open = colDef(show =F),
    perc_min_open = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<br/>


<!-- *Download unused slots from `r date_start` to `r date_start_next30`*<br/> -->
<!-- ```{r Unused Slots Detail (Physicians), echo = FALSE, warning = FALSE, message = FALSE} -->
<!-- # Table Output ----------------------------------------------------------------- -->
<!-- htmltools::browsable( -->
<!--   tagList( -->
<!--     tags$button( -->
<!--       tagList(fontawesome::fa("download"), "Download Unused Slots"), -->
<!--       onclick = "Reactable.downloadDataCSV('unused-slots-detail-physician', 'Unused Slots Next 30 Days')" -->
<!--     ), -->
<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     div(tags$label("Group by", `for` = "cars-grouping-select")), -->
<!-- #     tags$select( -->
<!-- #       id = "cars-grouping-select", -->
<!-- #       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])", -->
<!-- #       tags$option("None", value = c("Campus","Campus.Specialty.Group")), -->
<!-- #       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")), -->
<!-- #       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option) -->
<!-- #       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option) -->
<!-- #     ), -->
<!-- # -->
<!-- #     tags$hr("aria-hidden" = "true"), -->
<!-- reactable( -->
<!--   open_slots_detail %>% -->
<!--     mutate(slot_date = as.character(slot_date), -->
<!--            SLOT_BEGIN_TIME = as.character(SLOT_BEGIN_TIME)) %>% -->
<!--     arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, slot_year_month, SLOT_BEGIN_TIME) %>% -->
<!--     filter(PROV_TYPE == "Physician"), -->
<!--   elementId = "unused-slots-detail-physician", -->
<!--   # elementId = "cars-grouping-table", -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px', -->
<!--                color = 'white'), -->
<!--     defaultColDef = colDef(align = "left", -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->

<!--   #   highlight = TRUE, -->
<!--   #   # filterable = TRUE, -->
<!--   #   pagination = FALSE, -->
<!--   #   # height = 800, -->
<!--   #   wrap = TRUE, -->
<!--   # searchable = TRUE, -->

<!--   groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID") -->

<!--   # columnGroups = list( -->
<!--   #   colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WD", "PROV_TYPE", "ACTIVE_STATUS", "SLOT_BEGIN_TIME", "FINAL_BLOCKS"), -->
<!--   #            headerStyle = list(color = "black", fontSize = "15px"), -->
<!--   #            sticky = "left"), -->
<!--   #   colGroup(name = paste0("Slot Openings"), -->
<!--   #            columns = c("reg_openings", "sched_num", "unused_num"), -->
<!--   #            headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--   #   colGroup(name = paste0("Slot Minutes"), -->
<!--   #            columns = c("avail_min", "sched_min", "unused_min"), -->
<!--   #            headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")) -->
<!--   #   ), -->

<!--   # columns = list( -->
<!--   #  -->
<!--   #   SITE = colDef( -->
<!--   #     name = "Site", -->
<!--   #     minWidth = 150), -->
<!--   #  -->
<!--   #   DEPT_SPECIALTY_NAME = colDef( -->
<!--   #     name = "Specialty", -->
<!--   #     minWidth = 180), -->
<!--   #  -->
<!--   #   DEPARTMENT_NAME = colDef( -->
<!--   #     name = "Department", -->
<!--   #     minWidth = 180), -->
<!--   #  -->
<!--   #   PROV_TYPE = colDef( -->
<!--   #     name = "Provider Type", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   PROV_NM_WID = colDef( -->
<!--   #     name = "Provider", -->
<!--   #     minWidth = 150), -->
<!--   #  -->
<!--   #   ACTIVE_STATUS = colDef( -->
<!--   #     name = "Provider Status", -->
<!--   #     minWidth = 80), -->
<!--   #  -->
<!--   #   slot_year_month = colDef( -->
<!--   #     name = "Year-Month", -->
<!--   #     minWidth = 80), -->
<!--   #  -->
<!--   #   slot_date = colDef( -->
<!--   #     name = "Slot Date", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   SLOT_BEGIN_TIME = colDef( -->
<!--   #     name = "Slot DTTM", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   SLOT_BEGIN_TIME = colDef( -->
<!--   #     name = "Slot Length", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   FINAL_BLOCKS = colDef( -->
<!--   #     name = "Blocks Assigned", -->
<!--   #     minWidth = 200), -->
<!--   #  -->
<!--   #   SLOT_LENGTH = colDef( -->
<!--   #     name = "Slot Length", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   REG_AVAIL_OPENINGS = colDef( -->
<!--   #     name = "Unused Openings", -->
<!--   #     aggregate = 'sum', -->
<!--   #     maxWidth = 200, -->
<!--   #     format = colFormat(separators = TRUE), -->
<!--   #     headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--   #     style = list(color = "#e00000", fontWeight = "Bold")), -->
<!--   #  -->
<!--   #   REG_AVAIL_MIN = colDef( -->
<!--   #     name = "Unused Minutes", -->
<!--   #     aggregate = 'sum', -->
<!--   #     maxWidth = 200, -->
<!--   #     format = colFormat(separators = TRUE), -->
<!--   #     headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--   #     style = list(color = "#e00000", fontWeight = "Bold")), -->
<!--   #  -->
<!--   #  -->
<!--   #   PROV_ID = colDef(show =F), -->
<!--   #   DEPARTMENT_ID = colDef(show =F), -->
<!--   #   slot_year = colDef(show =F), -->
<!--   #   slot_month = colDef(show =F), -->
<!--   #   sched_num = colDef(show =F), -->
<!--   #   SCHED_MIN = colDef(show =F), -->
<!--   #   perc_num_open = colDef(show =F), -->
<!--   #   perc_min_open = colDef(show =F) -->
<!--   # ) # Close Columns -->
<!--   ) # Close Reactable -->
<!--  ) -->
<!-- ) -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->

## Unused Slots (All Provider)
*Includes slots from `r date_start` to `r date_start_next30`*<br/>
```{r Unused Slots Summary (All), echo = FALSE, warning = FALSE, message = FALSE}
# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('unused-slots-summary', 'Block Combinations')"
    ),
# htmltools::browsable(
#   tagList(
#     div(tags$label("Group by", `for` = "cars-grouping-select")),
#     tags$select(
#       id = "cars-grouping-select",
#       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])",
#       tags$option("None", value = c("Campus","Campus.Specialty.Group")),
#       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")),
#       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option)
#     ),
#
#     tags$hr("aria-hidden" = "true"),
reactable(
  open_slots_summary %>%
    mutate(slot_date = as.character(slot_date)) %>%
    arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, slot_year_month, slot_date),
  elementId = "unused-slots-summary",
  # elementId = "cars-grouping-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),

    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID", "PROV_TYPE", "ACTIVE_STATUS"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Slot Openings"),
             columns = c("reg_openings", "sched_num", "unused_num"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Slot Minutes"),
             columns = c("avail_min", "sched_min", "unused_min"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px"))
    ),

  columns = list(

    SITE = colDef(
      name = "Site",
      minWidth = 150),

    DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 180),

    DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 180),

    PROV_TYPE = colDef(
      name = "Provider Type",
      minWidth = 100),

    PROV_NM_WID = colDef(
      name = "Provider",
      minWidth = 150),

    ACTIVE_STATUS = colDef(
      name = "Provider Status",
      minWidth = 80),

    slot_year_month = colDef(
      name = "Year-Month",
      minWidth = 80),

    slot_date = colDef(
      name = "Slot Date",
      minWidth = 100),
  
    reg_openings = colDef(
      name = "Available Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    sched_num = colDef(
      name = "Scheduled Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    unused_num = colDef(
      name = "Unused Openings",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['unused_num']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }")),
    
    avail_min = colDef(
      name = "Available Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    sched_min = colDef(
      name = "Scheduled Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px")),
    
    unused_min = colDef(
      name = "Unused Minutes",
      aggregate = 'sum',
      maxWidth = 200,
      format = colFormat(separators = TRUE),
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['unused_num']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }")),


    PROV_ID = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    slot_year = colDef(show =F),
    slot_month = colDef(show =F),
    perc_num_open = colDef(show =F),
    perc_min_open = colDef(show =F)
  ) # Close Columns
  ) # Close Reactable
 )
)

```
<br/>
<br/>


<!-- ```{r Unused Slots Detail (All), echo = FALSE, warning = FALSE, message = FALSE} -->
<!-- # Table Output ----------------------------------------------------------------- -->
<!-- htmltools::browsable( -->
<!--   tagList( -->
<!--     tags$button( -->
<!--       tagList(fontawesome::fa("download"), "Download Unused Slots"), -->
<!--       onclick = "Reactable.downloadDataCSV('unused-slots-detail', 'Unused Slots Next 30 Days')" -->
<!--     ), -->
<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     div(tags$label("Group by", `for` = "cars-grouping-select")), -->
<!-- #     tags$select( -->
<!-- #       id = "cars-grouping-select", -->
<!-- #       onchange = "Reactable.setGroupBy('cars-grouping-table', this.value ? [this.value] : [])", -->
<!-- #       tags$option("None", value = c("Campus","Campus.Specialty.Group")), -->
<!-- #       # tags$option("Test", value = c("Appt.Source.New","Campus.Specialty.Group")), -->
<!-- #       # lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option) -->
<!-- #       lapply(c("Campus", "Campus.Specialty.Group", "Appt.Source.New"), tags$option) -->
<!-- #     ), -->
<!-- # -->
<!-- #     tags$hr("aria-hidden" = "true"), -->
<!-- reactable( -->
<!--   open_slots_detail %>% -->
<!--     mutate(slot_date = as.character(slot_date), -->
<!--            SLOT_BEGIN_TIME = as.character(SLOT_BEGIN_TIME)) %>% -->
<!--     arrange(MSHS, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, slot_year_month, SLOT_BEGIN_TIME), -->
<!--   elementId = "unused-slots-detail", -->
<!--   # elementId = "cars-grouping-table", -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px', -->
<!--                color = 'white'), -->
<!--     defaultColDef = colDef(align = "left", -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->

<!--   #   highlight = TRUE, -->
<!--   #   # filterable = TRUE, -->
<!--   #   pagination = FALSE, -->
<!--   #   # height = 800, -->
<!--   #   wrap = TRUE, -->
<!--   # searchable = TRUE, -->

<!--   groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WID") -->

<!--   # columnGroups = list( -->
<!--   #   colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "slot_year_month", "slot_date", "PROV_NM_WD", "PROV_TYPE", "ACTIVE_STATUS", "SLOT_BEGIN_TIME", "FINAL_BLOCKS"), -->
<!--   #            headerStyle = list(color = "black", fontSize = "15px"), -->
<!--   #            sticky = "left"), -->
<!--   #   colGroup(name = paste0("Slot Openings"), -->
<!--   #            columns = c("reg_openings", "sched_num", "unused_num"), -->
<!--   #            headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--   #   colGroup(name = paste0("Slot Minutes"), -->
<!--   #            columns = c("avail_min", "sched_min", "unused_min"), -->
<!--   #            headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")) -->
<!--   #   ), -->

<!--   # columns = list( -->
<!--   #  -->
<!--   #   SITE = colDef( -->
<!--   #     name = "Site", -->
<!--   #     minWidth = 150), -->
<!--   #  -->
<!--   #   DEPT_SPECIALTY_NAME = colDef( -->
<!--   #     name = "Specialty", -->
<!--   #     minWidth = 180), -->
<!--   #  -->
<!--   #   DEPARTMENT_NAME = colDef( -->
<!--   #     name = "Department", -->
<!--   #     minWidth = 180), -->
<!--   #  -->
<!--   #   PROV_TYPE = colDef( -->
<!--   #     name = "Provider Type", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   PROV_NM_WID = colDef( -->
<!--   #     name = "Provider", -->
<!--   #     minWidth = 150), -->
<!--   #  -->
<!--   #   ACTIVE_STATUS = colDef( -->
<!--   #     name = "Provider Status", -->
<!--   #     minWidth = 80), -->
<!--   #  -->
<!--   #   slot_year_month = colDef( -->
<!--   #     name = "Year-Month", -->
<!--   #     minWidth = 80), -->
<!--   #  -->
<!--   #   slot_date = colDef( -->
<!--   #     name = "Slot Date", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   SLOT_BEGIN_TIME = colDef( -->
<!--   #     name = "Slot DTTM", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   SLOT_BEGIN_TIME = colDef( -->
<!--   #     name = "Slot Length", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   FINAL_BLOCKS = colDef( -->
<!--   #     name = "Blocks Assigned", -->
<!--   #     minWidth = 200), -->
<!--   #  -->
<!--   #   SLOT_LENGTH = colDef( -->
<!--   #     name = "Slot Length", -->
<!--   #     minWidth = 100), -->
<!--   #  -->
<!--   #   REG_AVAIL_OPENINGS = colDef( -->
<!--   #     name = "Unused Openings", -->
<!--   #     aggregate = 'sum', -->
<!--   #     maxWidth = 200, -->
<!--   #     format = colFormat(separators = TRUE), -->
<!--   #     headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--   #     style = list(color = "#e00000", fontWeight = "Bold")), -->
<!--   #  -->
<!--   #   REG_AVAIL_MIN = colDef( -->
<!--   #     name = "Unused Minutes", -->
<!--   #     aggregate = 'sum', -->
<!--   #     maxWidth = 200, -->
<!--   #     format = colFormat(separators = TRUE), -->
<!--   #     headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--   #     style = list(color = "#e00000", fontWeight = "Bold")), -->
<!--   #  -->
<!--   #  -->
<!--   #   PROV_ID = colDef(show =F), -->
<!--   #   DEPARTMENT_ID = colDef(show =F), -->
<!--   #   slot_year = colDef(show =F), -->
<!--   #   slot_month = colDef(show =F), -->
<!--   #   sched_num = colDef(show =F), -->
<!--   #   SCHED_MIN = colDef(show =F), -->
<!--   #   perc_num_open = colDef(show =F), -->
<!--   #   perc_min_open = colDef(show =F) -->
<!--   # ) # Close Columns -->
<!--   ) # Close Reactable -->
<!--  ) -->
<!-- ) -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->

